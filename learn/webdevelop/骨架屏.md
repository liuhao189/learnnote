## 首屏加载的演进

人类可以在13ms内感知到离散图片的存在，并将图片的大概信息传输到我们的大脑中，在接下来的100到140ms之间，大脑会决定我们的眼镜具体关注图片的什么位置，也就是获取图片的关注焦点。

如果用户进行某项交互，要让用户感知不到延迟或数据加载，大概有200ms的时间来准备新的界面信息呈现给用户。

通常方案，会在首屏、或者获取数据时，在页面中展示一个进度条，或者转动的Spinner。

进度条：明确知道交互所需时间，或者知道一个大概值的时候我们选择使用进度条。

Spinner：无法预测获取数据，或者打开页面的时长。

2013年，Luke Wroblewski首次提出骨架屏的概念，并将这以概念成功运用到他当时的产品中。
他认为骨架屏是一个页面的空白版本，通过这个空白版本传递信息，我们的页面正在渐进式的加载过程中。

苹果公司已经将骨架屏写入自己的IOS人机交互指导中，该手册用了一个新的概念，推荐在应用首屏中包含文本或者元素基本的轮廓。

2015年，facebook在其移动端App中使用了骨架屏的设计来预览页面的加载状态。

## 为什么需要骨架屏

用户大概会在 200ms 内获取到界面的具体关注点，在数据获取或页面加载完成之前，给用户首先展现骨架屏，骨架屏的样式、布局和真实数据渲染的页面保持一致，这样用户在骨架屏中获取到关注点，并能够预知页面什么地方将要展示文字什么地方展示图片，这样也就能够将关注焦点移到感兴趣的位置。

前端框架层面，三个框架有一个共同的特点，都是 JS 驱动，在 JS 代码解析完成之前，页面不会展示任何内容，也就是所谓的白屏。用户是极其不喜欢看到白屏的，什么都没有展示，用户很有可能怀疑网络或者应用出了什么问题。 

## 如何构建骨架屏

饿了么移动web页面2016年，完全通过HTML和CSS手写的，手写骨架屏当然可以完全复现页面的真实样式。

缺点：每次需要的变更不仅需要修改业务代码，同时也要去修改骨架屏的样式和布局。手写骨架屏增加了维护成本。

服务器端渲染：不同框架下，服务器端渲染的技术已经相当成熟，开箱即用的方案也有。
服务器端渲染主要有两个目的：一是SEO，二是加快内容展现。
成本：需要服务器端的支持，设计服务构建、部署等；同时要考虑服务器的负载，以及相应的缓存策略。

预渲染：项目的构建过程中，通过一些渲染机制。比如puppeteer或jsdom将页面在构建的过程中就渲染好，然后插入到html中。启动之前首先看到的是预渲染的页面。

缺点：页面打包时数据打进html，真实数据可能已经和预渲染的数据有了很大的出入，而且预渲染的页面也是一个不可交互的页面。

## 生成骨架屏基本方案

通过 puppeteer 在服务端操控 headless Chrome 打开开发中的需要生成骨架屏的页面，在等待页面加载渲染完成之后，在保留页面布局样式的前提下，通过对页面中元素进行删减或增添，对已有元素通过层叠样式进行覆盖，这样达到在不改变页面布局下，隐藏图片和文字，通过样式覆盖，使得其展示为灰色块。然后将修改后的 HTML 和 CSS 样式提取出来，这样就是骨架屏。


## 文本块的骨架架构生成

文本块可以算是骨架屏生成中最复杂的一个区块了，正如上面也说的，任何只包含文本节点的元素都将视为文本块，在确定某个元素是文本块后，下一步就是通过一些 CSS 样式，以及元素的增减将其修改为骨架样式。

文本块的骨架屏也是通过线性渐变来绘制的。

## 图片块的骨架生成

我们选择了将一张1 * 1 像素的 gif 透明图片，转化成 dataUrl ，然后将其赋予给 IMG 元素的 src 特性上，同时设置图片的 width 和 height 特性为之前图片的宽高，将背景色调至为骨架样式所配置的颜色值。

## svg 块骨架结构

svg 块处理起来也比较简单，首先我们需要判断 svg 元素 hidden 属性是否为 true，如果为 true，说明该元素不展示的，所以我们可以直接删除该元素。

将会把 svg 元素内部所有元素删除，减少最终生成的骨架页面体积，其次，设置svg 元素的宽、高和形状等。

## 细节优化

首先，由上面一些代码可以看出，在我们生成骨架页面的过程中，我们将所有的共用样式通过 addStyle 方法缓存起来，最后在生成骨架屏的时候，统一通过 style 标签插入到骨架屏中。这样保证了样式尽可能多的复用。

其次，在处理列表的时候，为了生成骨架屏尽可能美观，我们对列表进行了同化处理，也就是说将 list 中所有的 listItem 都是同一个 listItem 的克隆。这样生成的 list 的骨架屏样式就更加统一了。

还有就是，正如前文所说，骨架屏仅是一种加载状态，并非真实页面，因此其并不需要完整的页面，其实只需要首屏就好了，我们对非首屏的元素进行了删除，只保留了首屏内部元素，这样也大大缩减了生成骨架屏的体积。

删除无用的 CSS 样式，只是我们只提取了对骨架屏有用的 CSS，然后通过 style 标签引入。

## 通过webpack将骨架屏打包到项目中

开发过程中生成骨架屏幕，主要为了骨架屏的可编辑。

## 怎样将骨架屏打包到项目中



