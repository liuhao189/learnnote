# 代码调整技术

本章重点讲述提高代码运行速度的方法，同时也对如何减小代码的资源占用给出一些建议。

程序性能通常同代码的速度和资源占用相关，但减小代码资源占用更主要的是通过对类和数据结构的重新设计来实现，而非代码调整。代码调整更多的是指小规模的修改，而非大范围的设计变更。

改变是以牺牲程序内部结构的某些特性来换取更高的性能。

# 逻辑

1、在知道答案后停止判断；一些语言提供了所谓的短路求值的表达式求值形式。不支持短路运算，避免使用and和or，应进一步使用逻辑判断。循环搜索也一样。

2、按照出现频率来调整判断顺序；让运行最快和判断结果最有可能为真的判断首先被执行。

3、相似逻辑结构之间的性能比较；没有什么代替测量得出的结论。

4、用查询表来替代复杂表达式；使用一张查询表回避穿梭在逻辑链路中更为高效。复杂逻辑链路的要点通常是对一些对象分类，然后根据类别采取相应动作。

5、使用惰性求值；惰性求值，避免做任何事情，直到迫不得已。惰性求值类似于即时完成。

# 循环

循环会被执行很多次，由此它也是程序热点最常见的藏身之处。

1、将判断外提；如果在循环运行时某个判断结果不会改变，你就可以把这个判断提取到循环的外面。牺牲了代码的可读性和可维护性。任何特定代码调整所带来的效果都是无法预计的。

2、合并或融合；两个对相同的一组元素进行操作的循环合并在一起。

3、展开；循环展开的目的是减少维护循环所需要做的工作，每次循环进行两次或更多的处理而非一次。完全展开循环是一种快速的解决办法，并且在对付少量元素时屡试不爽，如果遭遇大量元素或者无法预知元素数量，这样的方法就不适用了。风险在于结束后处理最后情况的代码中，可能出现off-by-one错误。

4、尽量减少在循环内部做的工作；高效循环的关键在于尽可能减少循环内部所做的工作。

5、哨兵值；如果该循环的判断条件是一个复合判断的时候，你可以通过简化判断来节省代码运行时间。任何使用线性查找的场合你都可以使用哨兵法。

6、把最忙的循环放在最内层；改进的关键在于解决外层循环执行的次数远远多于内层循环这以问题。

7、削减强度；多次轻量级运算来代替一次代价高昂的运算。

# 数据变换

数据类型的改变同样可以成为减少程序规模和改进执行速度方面的利器。

1、使用整型数而不是浮点数。整型数乘以特定值即可。

2、数组维度尽可能少。

3、尽可能减少数组引用。避免对二维或三维数组的访问。

4、使用辅助索引。添加相关数据，使得对某种数据类型的访问更给高效。可以添加到主数据类型中，或者存放到并行结构中。字符串长度索引，VB中字符串长度，在每个字符串的开始位置隐藏有一个长度字节。独立的平行的索引结构，可以创建一个辅助结构，里面存放关键码或指向详细信息的指针。

5、使用缓存机制；使得最常用的值会比不太常用的值更容易被获取。可以缓存那些需要耗费大量时间进行计算的结果-尤其是在参与计算的参数很简单的时候。缓存的成功取决于访问被缓存的元素、创建未缓存元素、以及缓存中保存新元素等动作相关的代价。

# 表达式

程序里的很多工作都是在数学或逻辑表达式中实现的。复杂的表达式往往代价昂贵。

1、利用代数恒等式，可以通过代数恒等式，用低代价的操作替代复杂操作。

2、削弱运算强度，用加法代替乘法，用乘法代替幂乘，用三角恒等式代替等价的三角函数，用long或int代替longlong整数，用定点数或整型代替浮点数，用单精度代替双精度值，用移位操作代替整数乘2或除2。

3、编译器初始化，如果在一个子程序中使用了一个具名常量或是神秘数值，而且它是子程序唯一的参数，应当提前计算这一数值，把结果放到某个常量中。

4、小心系统函数，系统函数运行起来很慢，提供的精度也是根本不需要的。

5、使用正确的常量类型，所使用的具名常量应当和被赋值的相应变量具有相同的类型。

6、预先算出结果，在详细设计阶段，常常需要做出的决定就是选择即时计算有关结果，还是提早把它们计算好并保存起来。在程序执行之前算出结果，然后把结果写入常量，在编译时赋值；在程序之前之间计算结果，然后把它们硬编码在运行时使用的变量中；程序执行之前计算结果，把结果存放在文件中，在运行时载入。程序启动时一次性计算出全部结果，每当需要时去引用。在第一次需要结果时进行计算，然后将结果保存起来以备后用。

7、删除公共子表达式。

# 子程序

代码调整的利器之一就是良好的子程序分解。短小，定义明确的子程序能够代替多处单独执行相同操作的代码，因而能够节省空间。

1、将子程序重写为内联，一些机器中调用子程序就可能严重地影响性能。

# 用低级语言重写代码

当程序遭遇性能瓶颈的时候，你应当用低级语言重写代码。把几小段代码在低级语言中重写，以此提高整体性能。

启用一个能顺带输出汇编代码列表的编译器，把汇编代码提取出来，保存到单独的源文件中。

# 变得越多，事情反而越没变

对每一次代码调整所产生的影响进行量化评估已经成了性能优化工作的永恒信条。代码调整所产生的影响都受制于编程语言，编译器，编译器的版本，代码库，库版本以及编译器设置等各种因素。

代码调整无可避免地为性能改善的良好愿望而付出了复杂性，可读性，简单性，可维护性方面的代价。

# 要点

1、优化结果在不同的语言，编译器和环境下有很大差异。如果没有对每一次的优化进行测量，你将无法判断优化到底是帮助还是损害了这个程序。

2、第一次优化通常不会是最好的，即使找到了效果很不错的，也不要停下扩大战果的步伐。

3、代码调整这一话题优点类似于核能，富有争议，甚至会让人冲动。一些人认为代码调整损害了代码的可读性和可维护性，它们绝对会将其弃之不用。其它人则认为只要有适当的安全保障，代码调整对程序是有益的，如果你决定使用本章所述的调整方法，请务必谨慎行事。