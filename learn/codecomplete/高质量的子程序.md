# 高质量的子程序

什么是子程序，子程序是为实现一个特定的目的而编写的一个可被调用的方法或过程。

子程序的使用使得程序变得更加易读，更易于理解，比任何编程语言的任何功能特性都更容易。

## 创建子程序的正当理由

1、降低复杂度，创建子程序的一个最重要的原因，就是为了降低程序的复杂度。还要缩小代码规模，改善可维护性，提高正确性等。当内部循环或条件判断的嵌套层次很深时，就意味着需要从子程序中提取出新的子程序了。

2、引入中间，易懂的抽象，把一段代码放入一个命名恰当的子程序内，是说明这段代码用意最好的方法之一。getLeafName

3、避免重复代码，两端子程序中重复代码提取出来，将其中的相同部分放入新的子程序中，再让其余的代码来调用这个子程序。

4、支持子类化，覆盖简短而规整的子程序所需新代码的数量，要比覆盖冗长而邋遢的子程序更少。

5、隐藏顺序，把处理事件的顺序隐藏起来是一个好主意。

6、隐藏指针操作，指针操作的可读性通常都很差，而且也容易出错。通过把这些操作隔离在子程序内部，就可以把经理集中于操作的意图本身。

7、提高可移植性，可以用子程序来隔离程序中不可移植的部分，从而明确识别和隔离未来的移植工作。

8、简化复杂的布尔判断，理解程序的流程，并没有必要去研究那些复杂的布尔判断的细节，应该把这些判断放入函数中，以提高代码的可读性。把判断的细节放到一边了，一个具有描述性的函数名字可以概括出该判断的目的。

9、改善性能，通过使用子程序，可以只在一个地方优化代码。代码集中在一处可以更方便地查出哪些代码的运行效率低下，更容易修改。

10、确保所有的子程序都很小，有些事情写一个大的子程序来完成还会更好。

## 似乎过于简单而没必要写成子程序的操作

小子程序有很多优点，其一便是它们能够提高其可读性。此外，简单的操作常常会变成复杂操作。

## 总结

1、降低复杂度，引入中间的，易懂的抽象，简化复杂的逻辑判断，隔离复杂度，隐藏实现细节

3、避免代码重复，提高可移植性，改善性能，限制变化所带来的影响

4、支持子类化，隐藏顺序，隐藏指针操作

9、隐藏全局数据，形成中央控制点，促成可重用的代码，达到特定的重构目的

## 在子程序层上设计

内聚性是指子程序中各种操作之间联系的紧密程度。这样做的好处是得到更高的可靠性。

功能内聚性，最强的也是最好的一种内聚性，让一个子程序仅执行一项操作。

顺序上的内聚性，指在子程序内包含有需要按特定顺序执行的操作，这些步骤需要共享数据，而且只有在全部执行完毕后才完成一项完整的功能。

通信上的内聚性，一个子程序中的不同操作使用了同样的数据，但不存在其它任何联系。

临时的内聚性，含有一些因为需要同时执行才放到一起操作的子程序。临时性的子程序看做是一系列事件的组织者。

其它类型的内聚性都是不可取的，都会导致代码组织混乱，难于调试，不便修改。

### 不可取内聚

过程上的内聚性，一个子程序中的操作是按特定的顺序进行的。因为它把一组操作赋予特定的顺序，而这些操作并不需要为了除此之外的任何原因而彼此关联。

逻辑上的内聚性，若干操作被放入同一个子程序中，通过传入的控制标志选择执行其中的一项操作。子程序的控制流或所谓逻辑是将这些操作放到一起的唯一原因。子程序代码仅由一系列的if语句或者case语句，以及调用其它子程序的语句组成，那么创建这样一个具有逻辑上的内聚性的子程序通常也是可以的。

巧合的内聚性是指子程序中的各个操作之间没有任何可以看到的关联，它也被称为无内聚性或混乱的内聚性。

## 好的子程序名称

好的子程序名字能清晰地描述子程序所做的一切，这里是有效地给子程序命名的一些指导原则。

1、描述子程序所做的所有事情，子程序的名字应当描述其所有的输出结果以及副作用。

2、避免使用无意义的，含糊或表述不清的动词，有些动词的含义非常灵活，可以延伸到涵盖几乎任何含义。当动词handle处理用作事件处理这一特定的技术含义时是个例外。一个子程序仅有的问题就是其名字表述不清，而子程序本身也设计得很好。有些情况由于子程序执行的操作就是含糊不清的，最佳的解决方法辨识重新组织该子程序及任何与之相关的子程序。

3、不要仅通过数字来形成不同的子程序名字。数字无法显示出子程序所代表的抽象有何不同，因此这些子程序的命名也都很槽糕。

4、根据需要确定子程序名字的长度。变量名的最佳长度是9到15个字符，子程序通常比变量更为复杂，子程序命名的重点是尽可能含义清晰。

5、给函数命名时要对返回值有所描述。函数有返回值，精确地表述该函数将要返回的结果。

6、给过程起名时使用语句强烈的动词加宾语的形式。一个具有功能内聚性的过程通常是针对一个对象执行一种操作，过程的名字应该能反映该过程所做的事情，而一个针对某对象执行的操作需要一个动词+宾语形式的名字。在面向对象的语言中，你不用在过程中加入对象的名字，因为对象本身已经包含在调用语句中了。

7、准确使用对仗词，命名时遵守对仗词的命名规则有助于保持一致性，从而也提高可读性。first/last，fileOpen和fileClose，add/remove，increment/decrement，open/close，begin/end，insert/delete，show/hide，create/destroy，lock/unlock，source/target，min/max，start/stop，get/put，next/previous，up/down，get/set，old/new。

8、为常用操作确立命名规则，某些系统里，区分不同类别的操作非常重要，而命名规则往往指示这种区别的最简单也是最可靠的方法。

## 子程序可以写多长

理论上认为的子程序的最佳长度通常是一屏代码或打印出来一到两页的代码，也就是约50-150行代码。

子程序的内聚性，嵌套的层次，变量的数量，决策点的数量，解释子程序用意所需的注释数量以及其它一些跟复杂度相关的考虑实现等来解决子程序的长度。

## 如何使用子程序参数

子程序之间的接口是程序中最易出错的部分之一，程序中有39%的错误都是属于内部接口错误，也就是子程序间互相通信时所发生的错误。

1、按照输入，修改，输出的顺序排列参数，不要随机地或按字母顺序排列参数，而应该先列出仅作为输入用途的参数，然后是既作为输入又作为输出用途的参数，最后才是仅作为输出用途的参数。

2、如果N个子程序都用了类似的一些参数，应该让这些参数的排列顺序保持一致。子程序的参数顺序可以产生记忆效应，不一致的顺序会让参数难以记忆。

3、使用所有的参数，既然往子程序中传递一个参数，就一定要用到这个参数。

4、把状态或出错变量放在最后，只是附属于程序的主要功能。

5、不要把子程序的参数用做工作变量，应当使用局部变量。

6、在接口中对参数的假定加以说明，假定传递给子程序的参数具有某种特性，那么就要对这种假定加以说明。在代码使用断言。参数是仅用于输入的，要被修改的，还是仅用于输出的；表示数量的参数的单位；没有用枚举类型的话，应说明状态代码和错误值的含义；所能接受的数值的范围；不该出现的特定数值。

7、把子程序的参数个数限制在7个以内，人类很难同时记住超过7个单位的信息。编程语言如何支持复杂的数据类型，一直需要传递很多参数，说明子程序之间的耦合太过紧密了。应该重新设计这个或这组子程序，降低期间的耦合度。很多不同的子程序传递相同的信息，就请把这些子程序组成一个类，经常使用的数据用作类的内部数据。

8、给子程序传递用以维持其接口抽象的变量或对象。只需要3项数据就能进行操作的子程序，一种人认为：只应传递子程序所需的3项特定数据即可，可以最大限度地减少子程序之间的关联，从而降低其耦合度，使它们更容易读，更便于重用。整个对象传递给子程序就破坏了封装的原则。第二种，应该传递整个对象，不修改子程序接口的情况下，让被调用子程序能够灵活使用对象的其余成员，就可以保持接口更稳定。子程序要表达何种抽象是最关键的。调用之前装配的代码，调用之后出现拆卸的代码，都是子程序设计不佳的表现。需要经常修改子程序的参数表，而每次修改的参数都是来自于同一对象。

9、使用具名参数，某些语言中，可以显式地把形式参数和实际参数对应起来。使得参数的用法更具自我描述性。有助于避免因为用错参数而带来的错误。

10、确保实际参数与形式参数相匹配，形式参数也称为哑参数，是指在子程序定义中声明的变量，实际参数是指在实际的子程序调用中用到的变量，常量或表达式。

## 使用函数是要特别考虑的问题

现代的编程语言同时支持函数和过程，函数是指有返回值的子程序，过程是指没有返回值的子程序。返回类型为void的函数在语义上其实就是过程。

### 什么时候使用函数，什么时候使用过程

语言纯化论者们认为，一个函数应该只有一个返回值，这意味着函数只能接受仅用于输入的参数，并只通过函数本身返回一项结果。永远应该以它返回的值来命名。过程可以根据所需，接受任意数量的输入，修改和输出参数。

常用的编程实践是让函数像过程一样执行并返回状态值。

如果一个子程序的主要用途就是返回由其名字所指明的返回值，那么就应该使用函数，否则就应该使用过程。

### 设置函数的返回值

1、检查所有可能的返回路径，函数开头用一个默认值来初始化返回值是个很好的做法。

2、不要返回指向局部数据的引用或指针，一旦子程序执行结束，其局部数据就都出了作用域，任何指向局部数据的引用或指针也随之失效。

## 要点

创建子程序最主要的目的是提高程序的可管理性，当然也有其它一些好的理由。节省代码空间只是一个次要原因；提高可读性，可靠性和可修改性等原因都更重要一些。

有时候，把一些简单的操作写成独立的子程序也非常有价值。

子程序可以按照其内聚性分为很多类，而你应该让大多数子程序具有功能上的内聚性，这是最佳的一种内聚性。

子程序的名字是它的质量的指示器，如果名字槽糕单恰如其分，说明这个子程序设计得很差劲。名字槽糕而且又不准确，那么它就反映不出程序是干什么的，不管怎样，槽糕的名字都意味着程序需要修改。

只有在某个子程序的主要目的是返回由其名字所描述的特定结果时，才应该使用函数。

