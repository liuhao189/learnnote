JS经常会触发视觉变化，有时是直接通过样式操作，有时是会产生视觉变化的计算。

时机不当或长时间运行的JS可能是导致性能问题的常见原因。您应当设法尽可能减少其影响。

JS的性能分析可以说是一门艺术，因为您编写的JS代码与实际执行的代码完全不像。现代浏览器使用JIT编译器和各种各样的优化和技巧来尝试为您实现尽可能快的执行，这极大地改变了代码的动态。

## 使用requestAnimationFrame来实现视觉变化

当屏幕正在发生视觉变化时，您希望在适合浏览器的时间执行您的工作，也就是正好在帧的开头。保证JS在帧开始时运行的唯一方式是使用requestAnimationFrame。

框架或类库可能使用setTimeout或setInterval来执行动画之类的视觉变化，回调将在帧中的某个时点运行，可能刚好在末尾，这可能经常会使我们丢失帧，导致卡顿。

## 降低复杂性或使用Web Worker

JS在浏览器的主线程上运行，恰好与样式计算、布局以及许多情况下的绘制一起运行。如果JS运行时间过长，就会阻塞这些其它工作，可能导致帧丢失。

要妥善处理JS何时运行以及运行多久。eg：滚动之类的动画中，最好是想办法使JS保持在3-4毫秒的范围内。

在许多情况下，可以将纯计算工作移到Web Worker。eg：不需要DOM访问权限，数据操作或搜索往往很适合这种模型。

如果您的工作必须在主线程上执行，请考虑一种批量方法，将大型任务分隔为微任务，每个微任务所占时间不超过几毫秒，并且在每帧的requestAnimationFrame处理程序内运行。

此方法会产生UX和UI后果，您将需要使用进度或活动指示器来确保用户知道任务正在被处理。有助于主线程始终对用户交互作出快速响应。

## 了解JS的帧税

在评估一个框架、库或您自己的代码时，务必逐帧评估运行JS代码的开销。

如果发现有长时间运行的JS，则可以在DevTools用户界面的顶部启用JS分析器。

您将获得有关 JavaScript 中调用了哪些函数的更多信息，您可以评估 JavaScript 对应用性能的影响，并开始找出和修正函数运行时间过长的热点。

若不能移除，则将其移到 Web Worker中。

## 避免微优化JS

知道浏览器执行一个函数版本比另一个函数要快100倍可能会很酷。每帧调用这类函数的次数几乎总是很少，把重点放在JS微优化上通常是白费劲。

如果你开发的是游戏或计算开销很大的应用，您一般会将大量计算放入单个帧，在这种情况下各种办法都很有用。


