# 防御式编程

防御式驾驶，要建立这样一种思维，那就是你永远也不能确定另一位死机将要做什么。这样才能确保在其它人作出危险动作时你也不会受到伤害，你要承担起保护自己的责任，哪怕是其它死机犯的错误。

防御式编程的主要思想是：子程序应该不因传入的错误数据而被破坏，哪怕是由其它子程序产生的错误数据。

## 保护程序免遭非法输入数据的破坏

1、检查所有来源于外部的数据的值，从文件，用户，网络或其它外部接口中获取数据时，应检查所获得的数据只，以确保它在允许的范围内。

2、检查子程序所有输入参数的值，和检查源于外部的数值一样，只不过数据是来自与其它子程序而非外部接口。

3、决定如何处理错误的输入数据，一旦检测到非法的参数，你该如何处理它呢？可以从十几种不同的方案中选择其一。

## 断言

断言是指在开发期间使用的，让程序在运行时进行自检的代码。断言为真，则表明程序运行正常，而断言为假，则意味着它已经在代码中发现了意料之外的错误。

断言对于大型的复杂程序或可靠性要求极高的程序来说尤其有用。通过使用断言，程序员能更尽快地排查出因修改代码或者别的原因，弄进程序里的不匹配的接口假定和错误等。一个断言通常包含两个参数，一个描述假设为真时的情况的布尔表达式，和一个断言为假时需要显示的信息。

断言主要是用于开发和维护阶段，只是在开发阶段被编译到目标代码中，而在生成产品代码时并不编译进去。


### 建立自己的断言机制

很多编程语言都支持断言，自己写也是很方便的。

### 使用断言的指导建议

1、用错误处理代码来处理预期会发生的状态，用断言来处理绝不应该发生的状况。

2、避免把主要执行的代码放到断言中。

3、用断言来注解并验证前条件和后条件。前条件是子程序或类的调用方代码在调用子程序或实例化对象之前要确保为真的属性，前条件是调用方代码对其所调用的代码要承担的义务。后条件是子程序或类在执行结束后要确保为真的属性，后置条件是子程序或类对调用方代码所承担的责任。

4、对于高健壮性的代码，应该先使用断言再处理错误。子程序要么使用断言，要么使用错误处理代码来处理，不会同时使用两者。

### 错误处理技术

预料中可能发生的错误。

1、返回中立值，处理错误数据的最佳做法就是继续执行操作并简单地返回一个没有危害的值。

2、换用下一个正确的数据，处理数据流的时候，有时只需返回下一个正确的数据即可。

3、返回与前次相同的数据。

4、换用最接近的合法值，可以选择返回最接近的那个合法值。

5、把警告信息记录到日志文件中，在检测到错误数据的时候，可以选择在日志文件中记录一条警告信息，然后继续执行。是否加密或施加其它方式的保护。

6、返回一个错误码，可以决定只让系统的某些部分处理错误，其它部分则不在本地处理错误，而只是简单地报告有错误发生，并信任调用链上游的某个子程序会处理该错误。三种方式：设置一个状态变量的值；用状态值作为函数的返回值；用语言内建的异常机制抛出一个异常。

7、调用错误处理子程序或对象，错误处理集在一个全局的错误处理子程序或对象中。优点在于能把错误处理的职责集中到一期，从而让调试工作更为简单；代价是整个程序都要知道这个集中点并与之紧密耦合。

8、错误发生时显示出错信息，这种方法可以把错误处理的开销减到最少，然而它也可能会让用户界面中出现的信息散步到整个应用程序中。

9、用最妥当的方式在局部处理错误，一些设计方案要求在局部解决所有遇到的错误。给与程序员很大的灵活性，但也带来了显著的风险，系统整体无法满足对其正确性或可靠性的需求。

10、关闭程序，一旦检测到错误发生就会关闭。适用于人身安全攸关的应用程序。

### 健壮性和正确性

处理错误最恰当的方式要根据出现错误的软件的类别而定，有时更侧重于正确性，有时更侧重于健壮性。正确性意味着永不返回不准确的结果，哪怕不返回结果。健壮性意味着要不断尝试采取某些措施，保证软件可以持续地运转下去，哪怕有时做出一些不够准确的结果。

### 高层次设计对错误处理方式的影响

整个应用程序采用一致的方式处理非法的参数，对错误进行处理的方式会直接关系到软件能否满足在正确性，健壮性和其它非功能性指标方面的要求。确定一种通用的处理错误参数的方法，是架构层次的设计决策。

