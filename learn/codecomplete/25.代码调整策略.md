# 代码调整策略

60年代，计算机资源非常有限，效率成了人们极为关注的一个问题。
70年代，随着计算机功能越来越强大，意识到过份专注于性能会损害程序的可读性和可维护性。
80年代，微型计算机革命，效率问题又被推到前台。90年代，被人关注的程序则逐渐下降。
21世纪初，移动电话和PDA等设备上嵌入式软件收到的内存限制，以及解释型代码的执行时间过长，使效率再度成为一个热门话题。

    只有硬件设备性能低，效率才会收受到很大关注。其它情况下，需要考虑与可读性，可维护性的平衡。

可以在两个层面上考虑性能问题，策略上和技术上的。

策略层面上的性能问题，什么是性能，它的重要性，以及提高性能的一般性方法。

# 性能概述

代码调整只是提高性能的一种方法。

## 质量特性和性能

人们常常透过有色眼镜来观察这个世界，我们猜想，如果能编写出更好的代码，就会有更多的客户和消费者喜欢上我们的软件。

相对于代码质量，用户更关心的是程序的外在特性，只有在性能影响到了用户工作的时候，人们才会在乎纯粹的性能。用户更为重视的是程序的处理能力，程序员按时交付软件，提供一个清爽的用户界面，避免系统死机常常比程序性能更为重要。

如果过分强调速度，程序的整体性能常常不升反降。

## 性能和代码调整

一旦你选择把效率作为头等大事，无论重点是在处理速度还是在处理代码所占用的资源上。你应该从以下方面来思考效率问题。

1、程序需求，花费时间处理一个性能问题之前，请想清楚你的确是在解决一个确实需要解决的问题。

2、程序的设计，程序的设计包括设计单个程序的主要框架，主要包括程序如何被分解为子系统，子系统如何被分解为类，模块等。如果资源占用量和速度至关重要，应该仔细设计程序架构来满足这些要求，设计架构时优先考虑整体性能，然后再为单个的子系统，特征和类设置要达到的资源占用目标。

设置单独的资源占用目标将使得系统的最终性能可预测。把这些目标描述得越明确，越有可能来使子系统满足这些指标。可以设定一些目标，尽管无法直接实现高效率，但从长远来看却能促进效率的提升。

3、类和子程序设计，设计类和子程序的内部机制为高性能的设计提供了另一个机会。在这一层次的处理中，是否选择了合适的数据类型和算法将对性能产生重要影响。内存占用和执行速度。

4、同操作系统的交互，程序同外部文件，动态内存或输出设备打交道。有时编译器会生成系统调用，程序库使用了你未曾想到的系统调用。

5、代码编译，优秀的编译器能将清晰的高级语言代码转换为经过优化后的机器码。

6、硬件，最经济也是最有效的提升程序性能的方法就是购买新的硬件设备。

7、代码调整，代码调整是一种对正确代码进行调整的实践，可以使得代码的运行更为高效。较小规模的修改，可能会影响到单个的类，单个子程序，更为普遍的情况是寥寥几行代码。从系统设计到代码调整的各个层面上，都有可能极大地提高程序性能。

# 代码调整简介

代码调整不是改进性能的最有效的方法，完善程序架构，修改类的设计，选择更好的算法常常能带来更大幅度的性能提升。也不是最方便的方法，购买新的硬件或使用具有更好优化特性的编译器会更方便。也不是成本最低的方法，初期阶段耗费在手工调整代码上的时间越多，这些代码在后期就会越难于维护。

掌握编写高效代码的这门艺术是成为严肃意义上程序员所需的加冕仪式。

代码调整的问题在于，高效的代码并不一定就是更好的代码。

## Pareto法则

Pareto法则讲述的是你可以用20%的努力取得80%的成效，这一法则适用于程序设计之外的众多领域，它对程序优化也绝对有效。

程序员应该衡量代码的各个部分，找出最需要关注的地方，然后集中火力来对付占用了绝大部分资源的少量代码。

## 一些无稽之谈

在高级语言中，减少代码的行数就可以提升所生成的机器代码的运行速度，或是减少其资源占用。高级语言代码行数和程序最终的资源占用和运行速度之间并无必然联系。

特定运算可能比其他的快，代码规模也较小。应该实际地测量程序的性能，这样才能知道你的改动到底是提升了还是降低了程序性能。

应当随时随地进行优化，为微观范围的优化忙得不可开交，而对整个系统全局性的重要优化视而不见。不成熟优化的主要缺陷在于它缺乏前瞻性，受到损害的包括最终代码的运行速度，比代码速度更为重要的性能特性，程序质量，直至最终软件用户。

程序的运行速度同其正确性同等重要，运行速度或资源占用是程序员需要重点考虑的问题，这种类型的项目比人们通常所认为的要少，并且随着时间的推移会越来越少。

## 何时调整代码

程序已经完成并正确之后，再去检查系统的性能，如果程序运行迟钝，那么再设法让它更快更小。


## 编译器优化

与那些充满技巧的代码相比，编译器的优化功能对那些平铺直叙的代码更有效。打开编译器的优化选项。

# 蜜糖和哥斯拉

需要仔细完成程序的性能剖测，明确哪一个部分的代码是笨拙不堪的。

## 常见的低效率之源

1、输入输出操作，程序效率低下的根源之一就是不必要的输入输出，内存访问所带来的高效。缓存。

2、分页，引发操作系统交互内存页面的运算会比在内存中同一页中进行的运算慢许多。

3、系统调用，调用系统子程序的代价常常是十分可观的。涉及系统的上下文切换。编写自己的服务程序，避免进入系统，尝试同系统软件商沟通。

4、解释型语言。

5、错误，程序性能的终极麻烦就是代码中的错误。没有去掉调试代码，忘了释放内存，数据库表设计失误，轮询并不存在的设备直至超时。

# 性能测试

某些一小部分常常会耗费同自己体积不成正比的运算时间，应当测量代码性能，找出代码中的热点。

经验对性能优化也没有太大的帮助，一个人的经验或许来源于一台老掉牙的计算机，或许来自于过时的语言或编译器，在任何一种因素发生改变后，所有的经验之谈也会成为狗屁。

## 性能测量应当精确

性能测量应当精确，用时间来计算程序的运行时间。应当用分配给程序的CPU时钟来计算，而不是日期时钟。

# 反复调整

如果你的坑挖得足够深，你总会看到惊人的宝藏。

# 代码调整方法总结

1、用设计良好的代码来开发软件，从而使程序易于理解和修改。

2、如果程序性能很差，保存代码的可运行版本，对系统进行分析测量，找出热点；判断性能拙劣是否源于设计、数据类型或算法上的缺陷，确定是否应该做代码调整；瓶颈代码进行调整；每次调整后都对性能提升进行测量；没有改进代码的性能，就恢复到步骤a保存的代码，超过一半的调整都只能稍微改善性能甚至造成性能恶化。

# 要点

1、性能只是软件整体质量的一个方面，通常不是最重要的。精细的代码调整也只是实现整体性能的一种方法，通常也不是决定性的。相对于代码本身的效率而言，程序的架构、细节设计以及数据结构和算法选择对程序的运行速度和资源占用的影响通常会更大。

2、定理测量是实现性能最优化的关键，定理测量需要找出真正决定程序性能的部分，在修改之后，应当通过重复测量需要找出能真正决定程序性能的部分，在修改之后，应当通过重复测量来明确修改是提高了还是降低了软件的性能。

3、绝大多数程序都有那么一小部分代码耗费了绝大部分的运行时间，如果没有测量，你不知道是哪一部分代码。

4、为性能优化工作做好准备的最佳方式就是在最初阶段编写清晰的代码，从而使代码在后续工作中易于理解和修改。



