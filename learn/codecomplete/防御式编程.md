# 防御式编程

理念来自防御式驾驶，要建立这样一种思维，那就是你永远也不能确定另一位司机将要做什么。这样才能确保在其它人作出危险动作时你也不会受到伤害，你要承担起保护自己的责任，哪怕是其它司机犯的错误。

防御式编程的主要思想是：子程序应该不因传入的错误数据而被破坏，哪怕是由其它子程序产生的错误数据。

## 保护程序免遭非法输入数据的破坏

1、检查所有来源于外部的数据的值，从文件，用户，网络或其它外部接口中获取数据时，应检查所获得的数据值，以确保它在允许的范围内。

2、检查子程序所有输入参数的值，和检查源于外部的数值一样，只不过数据是来自与其它子程序而非外部接口。

3、决定如何处理错误的输入数据，一旦检测到非法的参数，你该如何处理它呢？可以从十几种不同的方案中选择其一。

## 断言

断言是指在开发期间使用的，让程序在运行时进行自检的代码。断言为真，则表明程序运行正常，而断言为假，则意味着它已经在代码中发现了意料之外的错误。

断言对于大型的复杂程序或可靠性要求极高的程序来说尤其有用。通过使用断言，程序员能更尽快地排查出因修改代码或者别的原因，弄进程序里的不匹配的接口假定和错误等。一个断言通常包含两个参数，一个描述假设为真时的情况的布尔表达式，和一个断言为假时需要显示的信息。

断言主要是用于开发和维护阶段，只是在开发阶段被编译到目标代码中，而在生成产品代码时并不编译进去。


### 建立自己的断言机制

很多编程语言都支持断言，自己写也是很方便的。

### 使用断言的指导建议

1、用错误处理代码来处理预期会发生的状态，用断言来处理绝不应该发生的状况。

2、避免把主要执行的代码放到断言中。

3、用断言来注解并验证前条件和后条件。前条件是子程序或类的调用方代码在调用子程序或实例化对象之前要确保为真的属性，前条件是调用方代码对其所调用的代码要承担的义务。后条件是子程序或类在执行结束后要确保为真的属性，后置条件是子程序或类对调用方代码所承担的责任。

4、对于高健壮性的代码，应该先使用断言再处理错误。子程序要么使用断言，要么使用错误处理代码来处理，不会同时使用两者。

### 错误处理技术

预料中可能发生的错误。

1、返回中立值，处理错误数据的最佳做法就是继续执行操作并简单地返回一个没有危害的值。

2、换用下一个正确的数据，处理数据流的时候，有时只需返回下一个正确的数据即可。

3、返回与前次相同的数据。

4、换用最接近的合法值，可以选择返回最接近的那个合法值。

5、把警告信息记录到日志文件中，在检测到错误数据的时候，可以选择在日志文件中记录一条警告信息，然后继续执行。是否加密或施加其它方式的保护。

6、返回一个错误码，可以决定只让系统的某些部分处理错误，其它部分则不在本地处理错误，而只是简单地报告有错误发生，并信任调用链上游的某个子程序会处理该错误。三种方式：设置一个状态变量的值；用状态值作为函数的返回值；用语言内建的异常机制抛出一个异常。

7、调用错误处理子程序或对象，错误处理集在一个全局的错误处理子程序或对象中。优点在于能把错误处理的职责集中到一起，从而让调试工作更为简单；代价是整个程序都要知道这个集中点并与之紧密耦合。

8、错误发生时显示出错信息，这种方法可以把错误处理的开销减到最少，然而它也可能会让用户界面中出现的信息散步到整个应用程序中。

9、用最妥当的方式在局部处理错误，一些设计方案要求在局部解决所有遇到的错误。给与程序员很大的灵活性，但也带来了显著的风险，系统整体无法满足对其正确性或可靠性的需求。

10、关闭程序，一旦检测到错误发生就会关闭。适用于人身安全攸关的应用程序。

### 健壮性和正确性

处理错误最恰当的方式要根据出现错误的软件的类别而定，有时更侧重于正确性，有时更侧重于健壮性。正确性意味着永不返回不准确的结果，哪怕不返回结果。健壮性意味着要不断尝试采取某些措施，保证软件可以持续地运转下去，哪怕有时做出一些不够准确的结果。

### 高层次设计对错误处理方式的影响

整个应用程序采用一致的方式处理非法的参数，对错误进行处理的方式会直接关系到软件能否满足在正确性，健壮性和其它非功能性指标方面的要求。确定一种通用的处理错误参数的方法，是架构层次的设计决策。

## 异常

异常是把代码中的错误或异常事件传递给调用方代码的一种特殊手段。对出错的前因后果不甚了解的代码，可以把控制权转交给系统中其它能更好地解释错误并采取措施的部分。

1、用异常通知程序的其它部分，发生了不可忽略的错误。异常机制的优越之处在于它能提供一种无法被忽略的错误通知机制。

2、只在真正例外的情况下才抛出异常，仅在其它编码实践方法无法解决的情况下才使用异常。调用子程序的代码需要了解被调用代码中可能会抛出的异常，因此异常弱化了封装性。

3、不能用异常来推卸责任，如果某种的错误情况可以在局部处理，那就应该在局部处理掉它。

4、不要在构造函数和析构函数中抛出异常，除非你在同一地方把它们捕获。

5、在恰当的抽象层次抛出异常，子程序应在其接口中展现出一致的抽象，类也是如此，抛出的异常也是程序接口的一部分。

6、在异常消息中加入关于导致异常发生的全部信息，对于读取异常消息的人们来说是很有价值的，确保信息中含有为理解异常抛出原因所需的信息。

7、避免使用空的case语句，要么是try里的代码不对，无故抛出一个异常；要么是catch里的代码不对，没能有效处理一个异常。

8、了解所用函数库可能抛出的异常，一定要了解所用的函数库都会抛出哪些异常。

9、考虑创建一个集中的异常报告机制，确保异常处理的一致性，创建一个集中的异常报告机制。集中的存储，监控。

10、把项目中对异常的使用标准化，保持异常处理尽可能便于管理，可以使用以下途径对异常标准化。可以抛出哪些种类的异常建立一个标准；考虑创建项目的特定异常类，可用做项目中所有可能抛出的异常的基类，这样就能把记日志，报告错误等操作集中起来并标准化；规定何种场合允许代码使用throw-catch语句在局部对错误进行处理；规定在何种场合允许代码抛出不在局部进行处理的异常；确定是否要使用集中的异常报告机制。

11、考虑异常的替换方案，考虑各种各样的错误处理机制，局部处理错误，使用错误码来传递错误，日志文件中记录调试信息，关闭系统或其它的一些方式。

## 隔离程序，使之包容由错误造成的损害

隔栏是一种容损策略，以防御式编程为目的而进行隔离的一种方法，是把某些接口选定为安全区域的边界，对穿越安全区域边界的数据进行合法性校验，并当数据非法时做出敏锐的反映。让软件的某些部分处理不干净的数据，而让另一些部分处理干净的数据，即让大部分代码无需再担负检查错误数据的职责。

可以在类的层次采用这种方法，公用方法假设数据是不安全的，私用方法假定数据的安全的。

在输入数据时将其转化为恰当的类型，输入的数据通常都是字符串或数字的形式。长时间传递类型不明的数据，会增加程序的复杂度和崩溃的可能性。

### 隔离和断言的关系

隔离的使用使断言和错误处理有了清晰的区分，隔离外部的程序应使用错误处理技术，因为假定是不安全的。隔离内部的程序就应使用断言技术。

隔离的使用还展示了在架构层次上规定应该如何处理错误的价值，规定隔离内外的代码是一个架构层次上的决策。

## 辅助调试的代码

防御式编程的另一重要方面是使用调试助手，调试助手非常强大，可以帮助快速地检测错误。

### 不要自动地把产品版的限制强加于开发版之上

应该在开发期间牺牲一些速度和对资源的使用，来换取一些可以让开发更顺畅的内置工具。

### 尽早引入辅助调试的代码

越早引入辅助调试的代码，它能够提供的帮助也越大。

### 采用进攻式编程

开发阶段让异常显现出来，而在产品代码运行时让它能够自我恢复。eg：开发阶段，默认情况的case分支显示警告信息，最终的产品代码里，针对默认情况的处理应更稳妥一些，在日志文件中记录该消息。

1、确保断言语句使程序终止运行。

2、完全填充分配到的所有内存，可以让你检测到内存分配错误。

3、完全填充已分配到的所有文件和流，可以排查出文件格式错误。

4、确保每一个case语句中的default分支或else分支都能产生严重错误。

5、在删除一个对象之前把它填满垃圾数据。

6、让程序把它的错误日志文件用电子邮件发给你。


### 计划移除调试辅助的代码

1、使用类似ant和make这样的版本控制工具和make工具，从一套源码编译出不同版本的程序。

2、使用内置的预处理器，可以用编译器开关来包含或排除调试用的代码。

3、编写你自己的预处理器，可以很容易写一个，用于包含或排除代码。

4、使用调试存根，你可以调试一段子程序进行调试检查。

## 确定在产品代码中该保留多少防御式代码

开发阶段希望错误能引人注意，产品发布阶段，想让错误能尽可能地偃旗息鼓，让程序能十分稳妥地恢复或停止。

1、保留那些检查重要错误的代码，需要确定程序的哪些部分可以承担未检测出错误而造成的后果，而哪些部分不能承担。

2、去掉检查细微错误的代码，如果一个错误带来的影响确实微乎其微的话，可以把检查他的代码去掉。去掉指利用版本控制，预编译器开关或其它技术手段来编译不包含这段特定代码的程序。

3、去掉可以导致程序硬性崩溃的代码。导致数据丢失的调试代码，一定要把它们从最终产品中去掉。

4、保留可以让程序稳妥地崩溃的代码。能够检测出潜在严重错误的调试代码，应该保留那些能让程序稳妥地崩溃的代码。

5、为你的技术支持人员记录出错误信息，可以保留辅助调试用的代码，但要改变它们的工作方式，以便于最终产品软件相适应。

6、确认留在代码中的错误消息是友好的。

## 对防御式编程采取防御的姿态

过度的防御式编程也会引起问题，每一个能想到的地方用每一种能想到的方法检查从参数传入的数据，那么你的程序将会变得臃肿而缓慢。
引入的额外代码增加了软件的复杂度。

## 要点

最终产品代码中对错误的处理方式要比“垃圾进，垃圾出”复杂得多。

防御式编程技术可以让错误更容易发现，更容易修改，并减少错误对产品代码的破坏。

断言可以帮助人尽早发现错误，尤其是在大型系统和高可靠性的系统中，以及快速变化的代码中。

关于如何处理错误输入的决策是一项关键的错误处理决策，也是一项关键的高层设计决策。

异常提供了一种与代码正常流程角度不同的错误处理手段。如果留心使用异常，可以为程序员知识工具箱中的一项有益补充，同时也应该在异常和其它错误处理手段之间进行权衡比较。

针对产品代码的限制并不适用于开发中的软件，可以利用这一优势在开发中添加有助于更快地排查错误的代码。

