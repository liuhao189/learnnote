# 调试

调试是确定错误根本原因并纠正此错误的过程，调试可能占到整个开发周期的50%，对很多程序员来说，调试是程序设计中最为困难的部分。

# 调试概述

Bug一词可以追溯到第一台大型数字计算机Mark I，程序员们在一次解决电路故障的时候看到了一只大飞蛾在计算机里面，从此将计算机故障归咎于Bug。

## 调试在软件质量中所扮演的角色

调试是诊断代码缺陷的一种方法。开发高质量软件的最佳途径是精确描述需求，完善的设计，并使用高质量的代码编写规范。

## 调试效率的巨大差异

并不是每个人都知道怎么调试。最好的程序员能够找出最多的错误，最快地找出错误，并且往往能够正确改正错误。

## 让你有所收获的缺陷

理解你正在编写的程序，透彻理解了它，这个程序就不应该还有缺陷。

明确你犯了哪种类型的错误，从错误中有所成长，为什么会犯错误，如何才能更快发现错误，如何预防此类错误的发生。

从代码阅读者的角度分析代码质量，必须阅读自己的代码，以便发现其中的缺陷。带有挑剔的眼光审视自己代码质量的机会。代码易读吗？怎样才能更好？用你的结论重构你现在的代码，并让自己下次编写的代码更好。

审视自己解决问题的方法，你自己解决调试问题时用到的方法使你感到自信吗？你的方法管用么？能够很快地发现缺陷吗？调试过程中你有痛苦和挫败感吗？胡乱猜测么？调试方法需要改进么？花点时间来分析并改进你的调试方法，可能就是减少程序开发时间做有效方法。

审视自己修正缺陷的方法，关注自己如何修正缺陷，处理特殊情况进行简单包扎，还是从系统角度进行修正，通过精确的分析对问题的根本原因对症下药。

## 一种效率低下的调试方式

凭猜测找出缺陷，把print语句随机地散步在程序中。如果print语句还是不能找到缺陷，那么就在程序中修改点什么，直到有些东西好像能工作了。不要备份程序的原始版本，也不要记录你做了哪些改变。

不要把时间浪费在理解问题上，解决问题并不需要彻底弄懂程序。

用最唾手可得地方式修正错误，预期把时间浪在一个庞大的，甚至可能影响整个程序的修正工作上，还不如直接去解决你所面对的那个特殊问题。

迷信式调试，总会遇到无穷的问题，不听话的机器，奇怪的编译器错误，失效的数据，忘记做的重要改动。程序不会每次都产生不同的结果，他不是自己写出来的，是你写的，所以，请对它负责。

# 寻找缺陷

调试包括了寻找缺陷和修正缺陷，寻找缺陷并且理解缺陷通常占到整个调试工作的90%。高效地程序员只需花费低效程序员的1/20的时间，并不是随机地猜测如何修正程序，使用科学的方法。

## 科学地调试方法

经典的科学调试方法时，会经过如下步骤：

1、通关可重复的试验收集数据；

2、根据相关数据的统计构造一个假说；

3、设计一个实验来证明或反证这个假说。

寻找缺陷的有效方法：

1、将错误状态稳定下来；稳定地重现。

2、确定错误的来源，收集产生缺陷的相关数据，

3、分析所收集的数据，确定怎样去证实或证伪这个假设；

4、对假设作出做终结论。

5、修补缺陷，对所修补的地方进行测试，查找是还有类似的错误。

## 把错误的发生稳定下来

错误只是时不时地出现，几乎没有可能找出它发生的原因。在调试工作中，让某个不定期出现的错误有规律地重现几乎是最具挑战性的任务之一。

生成能产生错误的最小化测试用例，使它尽可能简单，其任何方面的修改都会改变相关错误的行为。

## 确定错误原因

确定错误原因同样需要运用科学方法。

## 寻找缺陷的一些小建议

一旦将错误的发生稳定下来并精简了产生该错误的测试用例，那么寻觅错误根源对你要么是小事一桩，要么会让你绞尽脑汁，取决于你的代码编写质量。

在构造假设时候考虑所有的可用数据，对缺陷原因创建某个假设时，考虑尽可能多的数据。

提炼产生错误的测试用例，如果无法确定错误的根源，那么可以尝试重新提炼测试用例。

在自己的单元测试族中测试代码，在一个小型代码片段中发现问题会容易很多。

利用可用的工具，交互式的调试器，吹毛求疵型编译器，内存检查工具，带有语法提示的编辑器。

采用多种不同的方法重现错误，尝试一些能产生相似错误，而本身又不尽相同的测试用例或许能让调试过程柳暗花明。

用更多的数据生成更多的假设。

利用否定性测试用例结果，将你的搜索领域进一步地压缩，剩下需要考虑的假设也更少了。

对可能的假设尝试头脑风暴，最初不要去分析它们，只是看看自己在几分钟的时间里能想出多少种不同的东西。

在桌面放一个记事本，把需要尝试的事情逐条列出。调试陷入困境的一个原因是他们在一条死胡同里面走得太久。

缩小嫌疑代码的范围，一直对整个程序或是整个类或子程序进行测试，请关注一个更小的部分。

对之前出现过缺陷的类和子程序保持警惕。

检查最近修改过的代码，如果出现了一个难于确诊的新错误，这个错误通常是同那些最近修改的代码相关的。

扩展嫌疑代码的范围。

增量式继承，一次只对系统添加一个代码片段，调试将会变得很容易。

检查常见缺陷，使用代码质量核对表来激发你对可能发生的缺陷的思考。

同其它人讨论问题，忏悔式调试。

抛开问题，休息一下。暂时放弃思考的好处是可以减少调试带来的焦虑。

蛮力调试，蛮力指的是一种或许会被认为乏味，费神，耗时但能确保最终可以解决问题的方法。
1、对崩溃代码的设计和编码进行彻底检查
2、抛弃有问题的代码，从头开始设计和编程；
3、抛弃整个程序，从头开始设计和编程
4、编译代码时生成全部的调试信息
5、在最为苛刻的警告级别中编译代码，不放过任何一个细微的编译器警告
6、全面执行单元测试，并将新的代码隔离起来单独测试
7、开发自动化测试工具，通宵达旦地对代码进行测试
8、在调试器中手动地遍历一个大的循环，直到发现错误条件
9、在代码中加入打印，显示和其它日志记录语句
10、用另一个不同的编译器来编译代码
11、在另一个不同的环境里编译和运行程序
12、在代码运行不正确的时候，使用能够产生警告信息的特殊库或者执行环境来链接和运行代码
13、复制最终用户的完整系统配置信息
14、将新的代码分小段进行集成，对每段集成的代码进行完整的测试

在使用快速肮脏调试法的时候设置一个时间上限，人们往往会放弃让缺陷无处遁行的彻底系统分析，而去进行快速的尝试。投机心理都宁愿用一种有可能在五分钟内发现缺陷的高风险方法，也不愿意为某种保证能找出缺陷的方法花上半个小时。

做出一张蛮力调试方法列表，开始调试一个难于解决的错误之前，确定至少一种解决问题的蛮力技术。

## 语法错误

语法错误的问题几乎要退出历史舞台了，显示诊断信息方面，编译器做得越来越好。

不要过分信任编译器信息中的行号，编译器可能没有正确理解问题，或只是简单地执行了一些拙劣的分析。

不要迷信编译器信息。

不要轻信编译器的第二条信息，无法找出第二条或第三条错误信息的源头，先把第一条处理，再重新编译。

分而治之，程序划分为几个部分的方法有助于寻找缺陷，尤其是那些语法错误。

找出没有配对的注释或引号。

# 修正缺陷

修正缺陷是较为简单的部分。程序员在第一次对缺陷进行修正的时候，有超过50%的几率出错。

在动手之前先要理解问题，理解程序本身，而不仅仅是问题。那些对整个程序有着全局性理解的程序员们成功修改程序的可能性要比那些仅仅关注与局部程序的程序员们高得多。

验证对错误的分析。

放松一下，匆忙动手解决问题是你所能做的最低效的事情之一，这将导致草率判断，片面分析，还有并不彻底地改正。

保存最初的源代码，原始版本的代码打包存放起来。

治本，而不是治标。你也应该解决问题的表象，但更应该把注意力放在解决更深层次的问题上。

修改代码时一定要有恰当的理由，在没有理解代码的时候对它所做的修改越大，你对它能正确工作的信心就越低。

一次只做一个改动。

检查自己的改动，自己用测试用例检查程序，确保与问题相关的方方面面都被考虑到了。

增加能暴露问题的单元测试，加入一个能揭示该错误的测试用例。

搜索类似的缺陷，缺陷常常会成群结队的出现，改掉这一类缺陷。

# 调试中的心理因素

调试是一种要求程序员花费大量脑力的工作。

## 心理取向如何导致调试时的盲目

心理取向-你会看到你所希望看到的。人总期望一个新的现象类似于他们见到过的某种现象。

心理取向对调试的影响：

1、它证明了养成良好的编程习惯的重要性。规范的格式、恰当的注释、良好的变量和子程序命名方式，以及其它编程风格要素都有助于构建编程的良好基础。

2、发现错误的时候，程序员对于需要检查的程序部分的选择方面。调试程序最高效的程序员们能够在调试时对程序中的无关部分视而不见。收缩研究范围，从而更快地发现问题。

## 心理距离在调试中的而作用

心理距离可以定义为区分两事物的难易程度。要警惕哪些没有足够心理距离的相似变量名或子程序名。

# 调试工具-明显的和不那么明显的

## 源代码比较工具

修改代码后出了错，diff这样的源代码比较工具就会非常有用。

## 编译器的警告信息

将编译器的警告级别设置为最高级，尽可能不放过任何一个警告，然后修正编译器所报告的全部错误。那些编写编译器的人对你所使用的语言的了解要远远胜过你自己。

用对待错误的态度来处理警告。使用这一功能的意义在于它能提升警告信息所显示出的重要性。让警告对编译过程产生影响。

在项目组范围内使用统一的编译设置，团队中使用统一的编译配置文件或编译脚本。

## 增强的语法检查和逻辑检查

可以使用其他工具对代码进行进一步的检查，这些检查将比编译器所提供的更为全面。静态代码检查工具，lint类。

## 执行性能测试

检查一下执行性能测试的输出结果，如果发现你的程序在每个区域内花费的时间都很合理，那么你就可以放心了。

## 测试框架/脚手架

找出有问题的代码，对其编写测试程序，然后通过运行程序找出问题。

## 调试器

优秀的调试器允许程序员设置断点，条件断点，回溯执行程序。

优秀的调试器允许程序员对数据进行全面的检查，包括结构化的和动态分配的数据。同时允许执行代码，然后继续运行程序。

可以查看高级语言或者由编译器所生成的汇编代码。针对每一个单独的程序保存你的调试参数。

调试工具就像拐杖一样，如果不依赖于这些工具，依靠自己的思考，你能更为快速跟准确地发现问题。

抛开一些经验主义的证据，那些反对调试器的基本理由其实并不成立。任何其它的强有力的工具都可能被正确使用或者乱用，调试器也是一样。

最有效的组合是良好的思维加上优秀的调试器。

# 要点

调试同整个软件开发的成败息息相关，最好的解决之道是使用本书中所介绍的其它方法来避免缺陷的产生。然而花点时间来提高自己的调试技能还是很划算的。

要想成功，系统化地查找和改正错误的方法至关重要，要专注于你的调试工作，让每一次测试都能让你朝着正确的方向前进一步。要使用科学地调试方法。

在动手解决问题之前，要理解问题的根本，胡乱猜测错误的来源和随机修改将会让你的程序陷入比刚开始调试时更为槽糕的境地。

将编译器警告级别设置为最严格，把警告信息所报告的错误都改正，如果你忽略了明显的错误，那么要改正那些微妙的错误就会非常麻烦。

调试工具对软件开发而言是强有力的支持手段，找出这些工具并加以应用。当然，请记得在调试的时候开动脑筋。


